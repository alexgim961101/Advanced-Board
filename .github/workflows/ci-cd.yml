name: Java CI/CD with Gradle and Docker

on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Jdk 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with gradlew
        run: ./gradlew clean build -x test --stacktrace

      # 도커 로그인
      - name: docker hub login
        uses: docker/login-action@v2
        with:
          username: alexgim961101
          password: dckr_pat_TTJ-o-UZExLLuSq43rZXAcejiz0

      - name: Docker Hub build And push
        run: |
          docker build -t alexgim961101/mailplug-app .
          docker images
          docker push alexgim961101/mailplug-app

      - name: Deploy to Prod EC2 Server
        uses: appleboy/ssh-action@master
        with:
          host: 43.202.142.100
          username: ec2-user
          key: -----BEGIN RSA PRIVATE KEY-----
            MIIEowIBAAKCAQEAwGSoSgM5B5aZjBn2DZbAVMvqyt0a9Bk7cDyOr7ieecny/nRP
            3xPbaiNALPBnNbWYzi25rOwButvnpOH1wJkhTRbicXVqpUxioin/eej1c2SSWmKu
            Htv8DYZ8mbTXroE9ap1hDOLNBeLroEN2Y7GeJbR5J2/vGfyXdpofVe1YQQlXj6ua
            q2Pvwwj0FB6cpUW0cZgSs52h/Pmp9HZuT4ax30TnbNG8ylU8u9arO3yEpmUQP0j/
            //46mSOGuYCaQBEEoiTKD/u5UnDJnTJkl/WrAW91cmGldVfiWiy/egKA4WeWqa1L
            rOSETJ93YLL56QGwyX+UqWKDvaIOtA1DaV28zwIDAQABAoIBAGJ2ITpfk9wyUrrE
            vowNzriW876GkbjDAQxbsZp0nYYuuFFJLWc5Pl1/VOSq0+dE3MMH27KHxgrfaBmW
            GrNKqyRMxe7S7JVUFlZvr/OwKY24tr3TKtFYPBKf9TyktIz2T3w0tuplWA/fJj+K
            xxgWWp1pU2e/fVqLTui/z7GmGjiNsBpFUju3tVGFHrcke9OhbhcWke5tfP25Heoa
            HRtZYJC4DJmV2FPzcQ58pkDzHJ7t4bACHpvoSwoqTv89nQDRud3ynuaK47TUSOqb
            ek8D/Lg4iKtYzI11G/FitiSBG8kLHB6zeBU7fWBlkAUAKfahGV8f0w3hlN3P8ZLD
            KstaUoECgYEA5dHT8xTd8O6OOKNYMkVFVzZOHRECftBN6cu83y1tAd5R2Um3qcxo
            fG+9eNXwk8QW+JJHjypPdBFS+DapdsxhEapV9GG8Md0T/CE1Y0nN40fhUz9qHnGS
            DStD0uDFTp1sITJf6w5KuGcCT9Z+JqFKd/Pc4wbDVhPtbCLffQUfcn8CgYEA1k9f
            FcPwNDA0ocMfW/6B3MEhaC3E+ApmPCZ3IV04KGacrHzITGA8RqXv8bhtVlJs3Nv2
            nOfTiuKiHFB9lw2aMNNhjw3jIERMuu4b7Pu8SJfmmtOrWqLqrDEmHIHbtac+++EA
            sY0UU6r49QXDQkyL9cHAOyHuFEvouaCuyS5g7bECgYAByPBpeecDYQbvv60Gru0L
            8VsH9MLdM0b3ouJzpUmscwqVsnHfuruxA7koABlfPG2lPpWZsg1t7FiFnv8P8iRq
            27TRMhUhGgN2uNdOTxtvQXapi9uKIv2sZoKfV6mQo75cP6TpEXJZHkuxTQwrxqLq
            bZVwmfPYbk0wwtCTiv+khwKBgDq69avZTnJ+422RM37aeGwu4SDTqi7vaqUBRZR3
            H3Sy6iy65YlItjwGLYNor04AuKSuAx9syKQ/B34K8N/8ckz/ILU7cQrerMhtiGmh
            cy/RsPitGUB1dSpLLc6SJ8vYUYJlXvNJXlCvghpjwebhY1muBygtXDljtBtq1Xt8
          port: 22
          # docker-compose가 있는 디렉토리로 이동해야 수행됩니다.
          script: |
            cd /home/ubuntu/mailplug-test/
            sudo docker login -u alexgim961101 -p dckr_pat_TTJ-o-UZExLLuSq43rZXAcejiz0
            sudo docker rm -f $(sudo docker ps -qa)
            sudo docker pull alexgim961101/mailplug-app
            sudo docker-compose up
            sudo docker image prune -f

